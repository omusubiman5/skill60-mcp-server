// SKILL60+ æ–¹è¨€ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ„ãƒ¼ãƒ«ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ã®ã¿ã€LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã—ï¼‰
// å›½ç«‹å›½èªç ”ç©¶æ‰€ï¼ˆNINJALï¼‰ã®æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’å–å¾—

import { z } from "zod";
import type { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { fetchSite } from "../services/fetcher.js";
import { logError } from "../services/db.js";

// === åœ°åŸŸåˆ¥æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ï¼ˆNINJALç­‰ã‹ã‚‰å–å¾—ã—ãŸåŸºæœ¬æƒ…å ±ï¼‰ ===

const DIALECT_DATA: Record<string, {
  characteristics: string[];
  vocabulary: string[];
  expressions: string[];
  phonetic: string[];
}> = {
  "ç¦äº•": {
    characteristics: ["å¶ºåŒ—æ–¹è¨€ãƒ™ãƒ¼ã‚¹", "äº¬é˜ªå¼ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ", "èªå°¾ã®ã€Œï½ã‚„ã–ã€ã€Œï½ã®ã‰ã€ãŒç‰¹å¾´"],
    vocabulary: ["ã»ã‚„ã»ã‚„ï¼ˆãã†ãã†ï¼‰", "ã¤ã‚‹ã¤ã‚‹ã„ã£ã±ã„ï¼ˆæº€æ¯ï¼‰", "ãŠã¡ã‚‡ãã‚“ï¼ˆæ­£åº§ï¼‰", "ã›ã‚ã—ãªã„ï¼ˆå¿™ã—ã„ï¼‰"],
    expressions: ["ï½ã‚„ã–ï¼ˆï½ã ã‚ˆï¼‰", "ï½ã®ã‰ï¼ˆï½ã­ï¼‰", "ã»ã‚“ãªã“ã¨ï¼ˆãã‚“ãªã“ã¨ï¼‰"],
    phonetic: ["ã‚¨ã¨ã‚¤ã®ä¸­é–“éŸ³", "èªå°¾ã®ä¸Šæ˜‡èª¿ãŒå¼·ã„"],
  },
  "å¤§é˜ª": {
    characteristics: ["é–¢è¥¿å¼ã®ä»£è¡¨", "é«˜ä½ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ", "èªå°¾ã®ã€Œï½ã‚„ã­ã‚“ã€ã€Œï½ã‚„ã§ã€"],
    vocabulary: ["ã»ã‚“ã¾ï¼ˆæœ¬å½“ï¼‰", "ã‚ã£ã¡ã‚ƒï¼ˆã¨ã¦ã‚‚ï¼‰", "ã‚ã‹ã‚“ï¼ˆã ã‚ï¼‰", "ãªã‚“ã§ã‚„ã­ã‚“ï¼ˆãªãœã ï¼‰"],
    expressions: ["ï½ã‚„ã­ã‚“ï¼ˆï½ãªã‚“ã ï¼‰", "ï½ã‚„ã§ï¼ˆï½ã ã‚ˆï¼‰", "ï½ã—ã¯ã‚‹ï¼ˆï½ã•ã‚Œã‚‹ã€å°Šæ•¬ï¼‰"],
    phonetic: ["ã€Œãˆã€ãŒã€Œeã€ã‚ˆã‚Šã€ŒÉ›ã€ã«è¿‘ã„", "èªå°¾ãŒå¼·ãä¸‹ãŒã‚‹"],
  },
  "æ±äº¬": {
    characteristics: ["æ¨™æº–èªã«è¿‘ã„", "å¹³æ¿ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ", "èªå°¾ã®ã€Œï½ã˜ã‚ƒã‚“ã€"],
    vocabulary: ["ã ã‚ˆã­", "ã˜ã‚ƒã‚“", "ï½ã£ã™ï¼ˆã§ã™ï¼‰"],
    expressions: ["ï½ã˜ã‚ƒã‚“ï¼ˆï½ã§ã—ã‚‡ã†ï¼‰", "ï½ã£ã¤ã£ã¦ï¼ˆï½ã¨è¨€ã£ã¦ï¼‰"],
    phonetic: ["ç„¡ã‚¢ã‚¯ã‚»ãƒ³ãƒˆåŒ–ãŒé€²ã‚€", "ã€Œã—ã€ã€Œã²ã€ã®åŒºåˆ¥ãŒå¼±ã¾ã‚‹"],
  },
  "äº¬éƒ½": {
    characteristics: ["äº¬éƒ½å¼", "ã¯ã‚“ãªã‚Šã—ãŸå£èª¿", "èªå°¾ã®ã€Œï½ã©ã™ã€ã€Œï½ãˆã€"],
    vocabulary: ["ãŠãŠãã«ï¼ˆã‚ã‚ŠãŒã¨ã†ï¼‰", "ã¯ã‚“ãªã‚Šï¼ˆä¸Šå“ï¼‰", "ãŠã°ã‚“ã–ã„ï¼ˆæƒ£èœï¼‰"],
    expressions: ["ï½ã©ã™ï¼ˆï½ã§ã™ï¼‰", "ï½ãˆï¼ˆï½ã§ã™ã‚ˆï¼‰", "ãŠã„ã§ã‚„ã™ï¼ˆã„ã‚‰ã£ã—ã‚ƒã„ï¼‰"],
    phonetic: ["èªå°¾ã®ä¼¸ã°ã—éŸ³", "æŸ”ã‚‰ã‹ã„ç™ºéŸ³"],
  },
  "åšå¤š": {
    characteristics: ["åšå¤šå¼", "ä¹å·æ–¹è¨€", "èªå°¾ã®ã€Œï½ã°ã„ã€ã€Œï½ãŸã„ã€"],
    vocabulary: ["ã‚ˆã‹ã‚ˆã‹ï¼ˆã„ã„ã‚ˆã„ã„ã‚ˆï¼‰", "ã›ã‹ã‚‰ã—ã‹ï¼ˆã†ã‚‹ã•ã„ï¼‰", "ãªã‚“ã—ã‚ˆã£ã¨ï¼ˆä½•ã—ã¦ã‚‹ã®ï¼‰"],
    expressions: ["ï½ã°ã„ï¼ˆï½ã ã‚ˆï¼‰", "ï½ãŸã„ï¼ˆï½ã ã‚ˆï¼‰", "ï½ã£ã¡ã‚ƒï¼ˆï½ã ã‚ˆï¼‰"],
    phonetic: ["ã€Œã¤ã€ãŒã€Œã¡ã‚…ã€ã«è¿‘ã„", "èªå°¾ã®å¼·èª¿"],
  },
  "åºƒå³¶": {
    characteristics: ["åºƒå³¶å¼", "ä¸­å›½æ–¹è¨€", "èªå°¾ã®ã€Œï½ã˜ã‚ƒã‘ã‚“ã€ã€Œï½ã˜ã‚ƒã‚ã€"],
    vocabulary: ["ã¶ã¡ï¼ˆã¨ã¦ã‚‚ï¼‰", "ãŸã„ããƒï¼ˆé¢å€’ï¼‰", "ã¿ã¦ã‚‹ï¼ˆãªããªã‚‹ï¼‰"],
    expressions: ["ï½ã˜ã‚ƒã‘ã‚“ï¼ˆï½ã ã‹ã‚‰ï¼‰", "ï½ã˜ã‚ƒã‚ï¼ˆï½ã§ã—ã‚‡ã†ï¼‰", "ï½ã‚“ã‚ˆï¼ˆï½ã ã‚ˆï¼‰"],
    phonetic: ["ã€ŒãŠã€ã®ç™ºéŸ³ãŒç‰¹å¾´çš„", "èªå°¾ã®ä¸‹é™èª¿"],
  },
  "æ²–ç¸„": {
    characteristics: ["ç‰çƒæ–¹è¨€", "ç‹¬è‡ªã®èªå½™ãŒå¤šã„", "èªå°¾ã®ã€Œï½ã•ãƒ¼ã€ã€Œï½ã‚„ãƒ¼ã€"],
    vocabulary: ["ãªã‚“ãã‚‹ãªã„ã•ï¼ˆãªã‚“ã¨ã‹ãªã‚‹ï¼‰", "ã‚ã‚“ããƒ¼ã‚Œï¼ˆã„ã‚‰ã£ã—ã‚ƒã„ï¼‰", "ã¡ã‚…ã‚‰ã•ã‚“ï¼ˆç¾ã—ã„ï¼‰"],
    expressions: ["ï½ã•ãƒ¼ï¼ˆï½ã ã‚ˆï¼‰", "ï½ã‚„ãƒ¼ï¼ˆï½ã ã‚ˆï¼‰", "ã†ã¡ãªãƒ¼ãã¡ï¼ˆæ²–ç¸„ã®è¨€è‘‰ï¼‰"],
    phonetic: ["ã€Œã¡ã‚…ã€ã€Œã¢ã€ã®éŸ³ãŒå¤šã„", "ç‹¬ç‰¹ã®ã‚¤ãƒ³ãƒˆãƒãƒ¼ã‚·ãƒ§ãƒ³"],
  },
  "åŒ—æµ·é“": {
    characteristics: ["åŒ—æµ·é“å¼", "æ±åŒ—å¼ã®å½±éŸ¿", "èªå°¾ã®ã€Œï½ã£ã—ã‚‡ã€"],
    vocabulary: ["ãªã¾ã‚‰ï¼ˆã¨ã¦ã‚‚ï¼‰", "ã—ãŸã£ã‘ï¼ˆãã‚Œã˜ã‚ƒã‚ï¼‰", "ã“ã‚ã„ï¼ˆç–²ã‚ŒãŸï¼‰"],
    expressions: ["ï½ã£ã—ã‚‡ï¼ˆï½ã§ã—ã‚‡ã†ï¼‰", "ï½ã ã¹ï¼ˆï½ã ã‚ã†ï¼‰", "ï½ã•ï¼ˆï½ã ã‚ˆï¼‰"],
    phonetic: ["ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãŒå¹³å¦", "èªå°¾ã®ä¸Šæ˜‡èª¿"],
  },
  "ç§‹ç”°": {
    characteristics: ["ç§‹ç”°å¼", "æ±åŒ—æ–¹è¨€", "èªå°¾ã®ã€Œï½ã ã™ã€"],
    vocabulary: ["ãªã‚“ã¼ï¼ˆã„ãã‚‰ï¼‰", "ã‘ã‚„ãï¼ˆå‹•ç‰©ï¼‰", "ã¾ã‚“ãšï¼ˆã¾ãšï¼‰"],
    expressions: ["ï½ã ã™ï¼ˆï½ã§ã™ï¼‰", "ï½ã‚“ã ï¼ˆï½ã®ã ï¼‰", "ï½ã¹ï¼ˆï½ã ã‚ã†ï¼‰"],
    phonetic: ["é¼»æ¿éŸ³ãŒå¤šã„", "æ¯éŸ³ã®ç„¡å£°åŒ–"],
  },
};

// === ã‚¹ã‚­ãƒ¼ãƒå®šç¾© ===

const DialectDataSchema = z.object({
  region: z.string().min(1).max(50).default("ç¦äº•")
    .describe("åœ°åŸŸåï¼ˆä¾‹: 'ç¦äº•', 'å¤§é˜ª', 'äº¬éƒ½', 'åšå¤š', 'åºƒå³¶', 'æ²–ç¸„', 'åŒ—æµ·é“', 'ç§‹ç”°', 'æ±äº¬'ï¼‰"),
  keyword: z.string().max(100).default("")
    .describe("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"),
}).strict();

// === ãƒ„ãƒ¼ãƒ«ç™»éŒ² ===

export function registerDialectTools(server: McpServer): void {

  server.registerTool(
    "skill60_dialect_data",
    {
      title: "æ–¹è¨€ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰",
      description: `å›½ç«‹å›½èªç ”ç©¶æ‰€ï¼ˆNINJALï¼‰ç­‰ã®æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰åœ°åŸŸã®æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

æä¾›æƒ…å ±:
- æ–¹è¨€ã®ç‰¹å¾´
- èªå½™ãƒ»è¡¨ç¾ä¾‹
- éŸ³å£°çš„ç‰¹å¾´

**ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã®ã¿ã€‚æ–¹è¨€å¤‰æ›ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è¡Œã„ã¾ã›ã‚“ã€‚**
LLMå´ã§ä¼šè©±ã®ä¸­ã‹ã‚‰å‡ºèº«åœ°ã‚’ç‰¹å®šã—ã€æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦æ–¹è¨€ã§è©±ã—ã¦ãã ã•ã„ã€‚

ä¸»è¦å¯¾å¿œåœ°åŸŸ: ç¦äº•, å¤§é˜ª, äº¬éƒ½, åšå¤š, åºƒå³¶, æ²–ç¸„, åŒ—æµ·é“, ç§‹ç”°, æ±äº¬`,
      inputSchema: DialectDataSchema,
      annotations: { readOnlyHint: true, destructiveHint: false, idempotentHint: false, openWorldHint: true },
    },
    async (params) => {
      try {
        let dialectInfo = DIALECT_DATA[params.region];

        // å®Œå…¨ä¸€è‡´ãŒãªã„å ´åˆã€éƒ¨åˆ†ä¸€è‡´ã‚’è©¦è¡Œ
        if (!dialectInfo) {
          for (const [key, data] of Object.entries(DIALECT_DATA)) {
            if (params.region.includes(key) || key.includes(params.region)) {
              dialectInfo = data;
              break;
            }
          }
        }

        // ãã‚Œã§ã‚‚ãªã„å ´åˆã€NINJAL URLã®ã¿è¿”ã™
        if (!dialectInfo) {
          const ninjalUrl = "https://www.ninjal.ac.jp/database/";
          return {
            content: [{
              type: "text" as const,
              text: `ğŸ—£ï¸ æ–¹è¨€ãƒ‡ãƒ¼ã‚¿\n` +
                    `åœ°åŸŸ: ${params.region}\n\n` +
                    `ã€å›½ç«‹å›½èªç ”ç©¶æ‰€ï¼ˆNINJALï¼‰ã€‘\n` +
                    `æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${ninjalUrl}\n\n` +
                    `â€»ã€Œ${params.region}ã€ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šè¨˜ã‚µã‚¤ãƒˆã§æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚`,
            }],
          };
        }

        // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
        let result = `ğŸ—£ï¸ æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰\n` +
                    `åœ°åŸŸ: ${params.region}\n\n` +
                    `ã€ç‰¹å¾´ã€‘\n${dialectInfo.characteristics.map(c => `- ${c}`).join('\n')}\n\n` +
                    `ã€èªå½™ä¾‹ã€‘\n${dialectInfo.vocabulary.map(v => `- ${v}`).join('\n')}\n\n` +
                    `ã€è¡¨ç¾ä¾‹ã€‘\n${dialectInfo.expressions.map(e => `- ${e}`).join('\n')}\n\n` +
                    `ã€éŸ³å£°ç‰¹å¾´ã€‘\n${dialectInfo.phonetic.map(p => `- ${p}`).join('\n')}\n\n` +
                    `ã€å‚è€ƒã€‘\nå›½ç«‹å›½èªç ”ç©¶æ‰€ï¼ˆNINJALï¼‰æ–¹è¨€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:\nhttps://www.ninjal.ac.jp/database/`;

        return {
          content: [{
            type: "text" as const,
            text: result,
          }],
        };
      } catch (e) {
        const errorMsg = e instanceof Error ? e.message : String(e);
        await logError("skill60_dialect_data", `æ–¹è¨€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${errorMsg}`, params);
        return {
          content: [{
            type: "text" as const,
            text: `âŒ æ–¹è¨€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${errorMsg}`,
          }],
        };
      }
    }
  );
}
